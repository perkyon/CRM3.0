<!DOCTYPE html>
<html>
<head>
    <title>Fix Storage Content-Types</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Исправление Content-Type документов</h1>
    <button id="fixBtn" style="padding: 10px 20px; font-size: 16px;">Исправить все документы</button>
    <div id="results" style="margin-top: 20px;"></div>
    
    <script>
        const SUPABASE_URL = 'https://xhclmypcklndxqzkhgfk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoY2xteXBja2xuZHhxemtoZ2ZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMDIzNTcsImV4cCI6MjA3MzY3ODM1N30.p4MmkvF4zwCQQB1zXxjYhr2tXSk_e6kG3b8GM0MAs_k';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const mimeTypes = {
          'png': 'image/png',
          'jpg': 'image/jpeg',
          'jpeg': 'image/jpeg',
          'gif': 'image/gif',
          'webp': 'image/webp',
          'pdf': 'application/pdf',
        };
        
        document.getElementById('fixBtn').addEventListener('click', async () => {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Загрузка...</p>';
            
            try {
                // Получаем все файлы из bucket
                const { data: files, error } = await supabase.storage
                    .from('client-documents')
                    .list('', { limit: 1000 });
                
                if (error) throw error;
                
                results.innerHTML = `<p>Найдено ${files.length} папок клиентов</p>`;
                
                let totalFixed = 0;
                
                // Для каждой папки клиента
                for (const folder of files) {
                    if (!folder.name) continue;
                    
                    const { data: clientFiles } = await supabase.storage
                        .from('client-documents')
                        .list(folder.name);
                    
                    if (!clientFiles) continue;
                    
                    results.innerHTML += `<p>Обработка ${folder.name}: ${clientFiles.length} файлов</p>`;
                    
                    // Для каждого файла
                    for (const file of clientFiles) {
                        const ext = file.name.split('.').pop()?.toLowerCase();
                        const contentType = mimeTypes[ext] || 'application/octet-stream';
                        
                        const filePath = `${folder.name}/${file.name}`;
                        
                        try {
                            // Скачиваем файл
                            const { data: fileBlob } = await supabase.storage
                                .from('client-documents')
                                .download(filePath);
                            
                            if (fileBlob) {
                                // Удаляем старый файл
                                await supabase.storage
                                    .from('client-documents')
                                    .remove([filePath]);
                                
                                // Загружаем с правильным Content-Type
                                await supabase.storage
                                    .from('client-documents')
                                    .upload(filePath, fileBlob, {
                                        contentType: contentType,
                                        upsert: true
                                    });
                                
                                totalFixed++;
                                results.innerHTML += `<p style="color: green;">✅ ${file.name} → ${contentType}</p>`;
                            }
                        } catch (e) {
                            results.innerHTML += `<p style="color: red;">❌ ${file.name}: ${e.message}</p>`;
                        }
                    }
                }
                
                results.innerHTML += `<h2 style="color: green;">Готово! Исправлено ${totalFixed} файлов</h2>`;
                
            } catch (error) {
                results.innerHTML += `<p style="color: red;">Ошибка: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>

